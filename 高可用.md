# 1.主从复制
## 1.1 基本原理
1、从库启动io线程与主库建立长连接<br>
2、主库启动dump线程，通过长连接将binlog发送到从库<br>
3、从库io线程将数据写入relaylog，<br>
4、从库sql线程重放relaylog。<br>
![图 0](images/2025-04-07-9ae2d5db3bbdc90200d8bf558a16a99d19a68fbeefb865f17be4f1b0edccb99b.png)  

## 1.2 主备延迟
造成原因：<br>
1、备库机器配置差，写入速度本身就慢<br>
2、备库除了写，可能还承担了一些执行时间很长的读，备库压力大<br>
3、大事务影响。<br>
4、备库的并行复制能力影响。

# 2.主备切换
基本流程为验证主备的延迟，如果延迟为0了，就将主库设置为仅可读，然后将业务请求切换到备库。有两种方案，可靠性优先和可用性优先方案。
## 2.1可靠性优先
可靠性方案会有一段时间不能写入数据，即2~5步骤会不可用，流程如下：<br>

1、判断备库的seconds_behind_master（延时时间），如果小于某个值则继续下一步，已减少不可用时间。<br>
2、将主库切换成只读，即readonly为true<br>
3、判断备库的seconds_behind_master的值，直到这个值变成0<br>
4、将备库改为可读写，即readonly设置成false<br>
5、将业务切换到备库<br>

## 2.2可用性优先
可用性优先可能导致数据不一致，因为会有同时写入的情况。
